!function(){"use strict";class t extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"});const t=document.createElement("style");t.textContent='\n      :host {\n        display: block;\n      }\n\n      .chat-bubble {\n        position: fixed;\n        bottom: 24px;\n        right: 24px;\n        width: 56px;\n        height: 56px;\n        background-color: var(--primary-color, #007BFF);\n        border-radius: 50%;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        transition: transform 0.3s, background-color 0.3s;\n        z-index: 9998;\n      }\n\n      :host([position="bottom-left"]) .chat-bubble {\n        left: 24px;\n        right: auto;\n      }\n\n      .chat-bubble:hover {\n        transform: scale(1.05);\n        background-color: var(--primary-hover, #0069d9);\n      }\n\n      .chat-bubble svg {\n        width: 24px;\n        height: 24px;\n        fill: none;\n        stroke: white;\n        stroke-width: 2;\n        stroke-linecap: round;\n        stroke-linejoin: round;\n      }\n\n      @keyframes pulse {\n        0% {\n          box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);\n        }\n        70% {\n          box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);\n        }\n        100% {\n          box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);\n        }\n      }\n\n      .chat-bubble.pulse {\n        animation: pulse 2s infinite;\n      }\n    ';const e=document.createElement("template");e.innerHTML='\n      <div class="chat-bubble pulse">\n        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\n          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>\n        </svg>\n      </div>\n    ',this.shadowRoot.appendChild(t),this.shadowRoot.appendChild(e.content.cloneNode(!0)),this.bubbleElement=this.shadowRoot.querySelector(".chat-bubble")}connectedCallback(){this.bubbleElement.addEventListener("click",(()=>{}))}attributeChangedCallback(t,e,n){"position"===t&&e!==n&&("bottom-left"===n?(this.bubbleElement.style.left="24px",this.bubbleElement.style.right="auto"):(this.bubbleElement.style.right="24px",this.bubbleElement.style.left="auto"))}static get observedAttributes(){return["position"]}}customElements.define("chat-button",t);class e extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){const t=this.getAttribute("sender")||"bot",e=this.getAttribute("avatar")||"",n=this.getAttribute("message-id")||"",s=this.textContent||"",o=document.createElement("style");o.textContent=`\n      :host {\n        display: block;\n        width: 100%;\n      }\n\n      .message {\n        display: flex;\n        flex-direction: column;\n        max-width: 85%;\n        margin-bottom: 12px; /* إضافة هامش سفلي بين الرسائل */\n        animation: fadeIn 0.3s ease-in-out;\n      }\n\n      .message-user {\n        align-self: flex-end;\n        align-items: flex-end;\n      }\n\n      .message-bot {\n        align-self: flex-start;\n        align-items: flex-start;\n      }\n\n      .avatar {\n        width: 28px;\n        height: 28px;\n        border-radius: 50%;\n        margin-right: 8px;\n        background-color: var(--primary-color, #007BFF);\n        color: white;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 14px;\n        font-weight: bold;\n        flex-shrink: 0; /* منع الصورة الرمزية من التقلص */\n      }\n\n      .message-header {\n        display: flex;\n        align-items: center;\n        margin-bottom: 4px;\n        /* فقط عرض الهيدر إذا كان المرسل هو البوت ولديه صورة رمزية */\n        ${"bot"===t?"":"display: none;"}\n      }\n\n      .message-content {\n        padding: 12px 16px;\n        border-radius: 18px;\n        font-size: 14px;\n        line-height: 1.4;\n        position: relative;\n        word-wrap: break-word; /* لضمان التفاف النص الطويل */\n      }\n\n      .message-user .message-content {\n        background-color: var(--message-bg-user, #007BFF);\n        color: var(--message-color-user, #fff);\n        border-bottom-right-radius: 4px;\n      }\n\n      .message-bot .message-content {\n        background-color: var(--message-bg-bot, #F1F1F1);\n        color: var(--message-color-bot, #333);\n        border-bottom-left-radius: 4px;\n      }\n\n      /* وضع الصورة الرمزية بجانب المحتوى للـ bot */\n       .message-bot {\n           flex-direction: row; /* تغيير الاتجاه إلى صف */\n           align-items: flex-start; /* محاذاة العناصر في بداية المحور العمودي */\n       }\n       .message-bot .message-header {\n           margin-bottom: 0; /* إزالة الهامش السفلي من الهيدر */\n           margin-right: 8px; /* إضافة هامش يمين للصورة الرمزية */\n       }\n        /* إخفاء الصورة الرمزية من الهيدر لأننا سنضعها مباشرة في .message-bot */\n       .message-bot .message-header .avatar {\n           display: none;\n       }\n\n       .message-bot > .message-content {\n           /* لا حاجة لتغييرات هنا حاليًا */\n       }\n\n       .message-bot > .message-time {\n         margin-left: 36px; /* تحريك الوقت ليتناسب مع محتوى الرسالة (28px avatar + 8px margin) */\n         text-align: left;\n       }\n\n       .message-user > .message-time {\n         text-align: right;\n       }\n\n\n      .message-time {\n        font-size: 11px;\n        color: var(--text-secondary, #666);\n        margin-top: 4px;\n      }\n\n      @keyframes fadeIn {\n        from { opacity: 0; transform: translateY(10px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n\n      /* تنسيق الروابط في الرسائل */\n      .message-content a {\n        /* استخدام لون مميز للروابط داخل رسائل البوت */\n        color: ${"bot"===t?"var(--primary-color, #007BFF)":"inherit"};\n        text-decoration: underline;\n      }\n\n      .message-content a:hover {\n        opacity: 0.8;\n      }\n\n      /* تنسيق الأكواد البرمجية في الرسائل */\n      .message-content pre {\n        background-color: rgba(0, 0, 0, 0.05);\n        padding: 10px; /* زيادة الحشو */\n        border-radius: 4px;\n        overflow-x: auto;\n        margin: 8px 0;\n        border: 1px solid rgba(0,0,0,0.1); /* إضافة حدود بسيطة */\n      }\n\n      .message-content code:not(pre > code) { /* تنسيق الكود المضمن فقط */\n         background-color: rgba(0,0,0,0.05);\n         padding: 2px 4px;\n         border-radius: 3px;\n         font-family: monospace;\n         font-size: 13px;\n       }\n      .message-content pre code { /* تنسيق الكود داخل <pre> */\n         background-color: transparent; /* بدون خلفية إضافية */\n         padding: 0;\n         border-radius: 0;\n         font-family: monospace;\n         font-size: 13px;\n         display: block; /* تأكد من أنه كتلة */\n         white-space: pre; /* الحفاظ على المسافات والأسطر */\n      }\n\n\n      /* تنسيق القوائم */\n      .message-content ul, .message-content ol {\n        padding-left: 24px;\n        margin: 8px 0;\n      }\n\n      /* تنسيق أزرار الإجراءات */\n      .action-button {\n        background-color: var(--primary-color, #007BFF);\n        color: white;\n        border: none;\n        padding: 8px 12px;\n        border-radius: 15px; /* جعلها أكثر دائرية */\n        cursor: pointer;\n        font-size: 13px;\n        margin: 5px 5px 5px 0; /* إضافة هوامش */\n        transition: background-color 0.2s ease;\n        display: inline-block; /* جعلها تظهر بجانب بعضها البعض */\n      }\n\n      .action-button:hover {\n        background-color: var(--primary-color-dark, #0056b3); /* لون أغمق عند المرور */\n      }\n    `;const a=this._processMessageContent(s),i=document.createElement("div");i.className=`message message-${t}`,i.setAttribute("data-message-id",n);let r="";"bot"===t&&(r=e?`<img class="avatar" src="${e}" alt="Bot Avatar">`:'<div class="avatar">🤖</div>');const c=new Date,d=`${c.getHours().toString().padStart(2,"0")}:${c.getMinutes().toString().padStart(2,"0")}`;i.innerHTML=`\n      ${"bot"===t?r:""}\n      <div class="message-body"> <div class="message-content">${a}</div>\n          <div class="message-time">${d}</div>\n      </div>\n    `,i.innerHTML="bot"===t?`\n             ${r}\n             <div style="display: flex; flex-direction: column; align-items: flex-start;">\n                 <div class="message-content">${a}</div>\n                 <div class="message-time">${d}</div>\n             </div>\n         `:`\n             <div class="message-content">${a}</div>\n             <div class="message-time">${d}</div>\n         `,this.shadowRoot.appendChild(o),this.shadowRoot.appendChild(i),this._activateLinks()}_processMessageContent(t){let e=t.replace(/</g,"&lt;").replace(/>/g,"&gt;");return e=e.replace(/```([\s\S]*?)```/g,((t,e)=>`<pre><code>${e.trim()}</code></pre>`)),e=e.replace(/`([^`]+)`/g,"<code>$1</code>"),e=e.replace(/(?<!<code[^>]*?>)(?<!<pre[^>]*?>)(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'),e=e.replace(/\[([^\]]+)\]\(action:([^)]+)\)/g,'<button class="action-button" data-action="$2">$1</button>'),e}_activateLinks(){this.shadowRoot.querySelectorAll(".action-button").forEach((t=>{t.hasAttribute("data-listener-added")||(t.addEventListener("click",(()=>{const e=t.getAttribute("data-action");this.dispatchEvent(new CustomEvent("action-clicked",{detail:{action:e},bubbles:!0,composed:!0}))})),t.setAttribute("data-listener-added","true"))}))}}customElements.get("chat-message")||customElements.define("chat-message",e);class n extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._suggestions=[]}connectedCallback(){this._render()}set suggestions(t){Array.isArray(t)&&(this._suggestions=t,this.shadowRoot&&this._render())}get suggestions(){return this._suggestions}_render(){const t=document.createElement("style");t.textContent="\n      :host {\n        display: block;\n        margin: 16px 0;\n      }\n\n      .suggestions {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 8px;\n        margin-top: 16px;\n      }\n\n      .suggestion {\n        background-color: var(--message-bg-bot, #F1F1F1);\n        color: var(--text-color, #333);\n        border: 1px solid var(--border-color, #E6E6E6);\n        border-radius: 16px;\n        padding: 8px 16px;\n        font-size: 13px;\n        cursor: pointer;\n        transition: background-color 0.2s, transform 0.2s;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        max-width: 200px;\n      }\n\n      .suggestion:hover {\n        background-color: var(--primary-color, #007BFF);\n        color: white;\n        transform: translateY(-2px);\n      }\n\n      .title {\n        font-size: 14px;\n        color: var(--text-secondary, #666);\n        margin-bottom: 8px;\n      }\n\n      @keyframes fadeIn {\n        from { opacity: 0; transform: translateY(10px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n\n      .suggestion {\n        animation: fadeIn 0.3s ease-in-out;\n        animation-fill-mode: both;\n      }\n\n      .suggestion:nth-child(1) { animation-delay: 0.1s; }\n      .suggestion:nth-child(2) { animation-delay: 0.2s; }\n      .suggestion:nth-child(3) { animation-delay: 0.3s; }\n      .suggestion:nth-child(4) { animation-delay: 0.4s; }\n    ";const e=document.createElement("div");e.innerHTML=`\n      <div class="title">يمكنك أن تسأل:</div>\n      <div class="suggestions">\n        ${this._suggestions.map((t=>`\n          <button class="suggestion">${t}</button>\n        `)).join("")}\n      </div>\n    `,this.shadowRoot.innerHTML="",this.shadowRoot.appendChild(t),this.shadowRoot.appendChild(e);this.shadowRoot.querySelectorAll(".suggestion").forEach((t=>{t.addEventListener("click",(()=>{const e=t.textContent;this.dispatchEvent(new CustomEvent("suggestion-clicked",{detail:{suggestion:e},bubbles:!0,composed:!0}))}))}))}}customElements.define("chat-suggestions",n);class s extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){const t=this.getAttribute("avatar")||"",e=document.createElement("style");e.textContent="\n      :host {\n        display: block;\n        width: 100%;\n      }\n\n      .typing-indicator {\n        display: flex;\n        align-items: flex-end;\n        margin-bottom: 10px;\n        animation: fadeIn 0.3s ease-in-out;\n      }\n\n      .avatar {\n        width: 28px;\n        height: 28px;\n        border-radius: 50%;\n        margin-right: 8px;\n        background-color: var(--primary-color, #007BFF);\n        color: white;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 14px;\n        font-weight: bold;\n      }\n\n      .typing-bubble {\n        background-color: var(--message-bg-bot, #F1F1F1);\n        border-radius: 18px;\n        padding: 12px 16px;\n        border-bottom-left-radius: 4px;\n        display: flex;\n        align-items: center;\n      }\n\n      .dot {\n        width: 8px;\n        height: 8px;\n        background-color: var(--text-secondary, #666);\n        border-radius: 50%;\n        margin: 0 2px;\n        opacity: 0.6;\n      }\n\n      .dot:nth-child(1) {\n        animation: bounce 1.2s infinite 0s;\n      }\n\n      .dot:nth-child(2) {\n        animation: bounce 1.2s infinite 0.2s;\n      }\n\n      .dot:nth-child(3) {\n        animation: bounce 1.2s infinite 0.4s;\n      }\n\n      @keyframes bounce {\n        0%, 60%, 100% {\n          transform: translateY(0);\n        }\n        30% {\n          transform: translateY(-4px);\n        }\n      }\n\n      @keyframes fadeIn {\n        from { opacity: 0; transform: translateY(10px); }\n        to { opacity: 1; transform: translateY(0); }\n      }\n    ";const n=document.createElement("template");let s="";s=t?`<img class="avatar" src="${t}" alt="Bot Avatar">`:'<div class="avatar">B</div>',n.innerHTML=`\n      <div class="typing-indicator">\n        ${s}\n        <div class="typing-bubble">\n          <div class="dot"></div>\n          <div class="dot"></div>\n          <div class="dot"></div>\n        </div>\n      </div>\n    `,this.shadowRoot.appendChild(e),this.shadowRoot.appendChild(n.content.cloneNode(!0))}}customElements.define("typing-indicator",s);class o extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){const t=this.getAttribute("src")||"",e=this.getAttribute("fallback")||"B",n=this.getAttribute("bg-color")||"#007BFF",s=this.getAttribute("size")||"40px",o=document.createElement("style");o.textContent=`\n      :host {\n        display: inline-block;\n      }\n\n      .avatar {\n        width: ${s};\n        height: ${s};\n        border-radius: 50%;\n        overflow: hidden;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-weight: 600;\n        color: white;\n        background-color: ${n};\n        font-size: calc(${s} * 0.4);\n      }\n\n      .avatar img {\n        width: 100%;\n        height: 100%;\n        object-fit: cover;\n      }\n    `;const a=document.createElement("template");a.innerHTML=t?`\n        <div class="avatar">\n          <img src="${t}" alt="Avatar" onerror="this.style.display='none'; this.parentNode.textContent='${e}'" />\n        </div>\n      `:`\n        <div class="avatar">${e}</div>\n      `,this.shadowRoot.appendChild(o),this.shadowRoot.appendChild(a.content.cloneNode(!0))}static get observedAttributes(){return["src","fallback","bg-color","size"]}attributeChangedCallback(t,e,n){if(e!==n&&this.shadowRoot){const e=this.shadowRoot.querySelector(".avatar");if(!e)return;if("src"===t){let t=e.querySelector("img");n?(t||(t=document.createElement("img"),t.setAttribute("alt","Avatar"),e.textContent="",e.appendChild(t)),t.setAttribute("src",n)):t&&(e.textContent=this.getAttribute("fallback")||"B",t.remove())}else if("fallback"===t){e.querySelector("img")||(e.textContent=n||"B")}else"bg-color"===t?e.style.backgroundColor=n:"size"===t&&(e.style.width=n,e.style.height=n,e.style.fontSize=`calc(${n} * 0.4)`)}}}customElements.define("chat-avatar",o);class a extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.isOpen=!1,this.messages=[],this.isTyping=!1,this.sessionId=this._loadSessionId(),this.currentBotMessageContainer=null,this.responseStartTime=null,this._initialize()}static get observedAttributes(){return["project-id","theme","position","welcome-message","api-url","direction","avatar","title","subtitle","powered-by","debug"]}_initialize(){this._render(),this._setupEventListeners(),setTimeout((()=>{const t=this.getAttribute("welcome-message")||"مرحبًا بك! كيف يمكنني مساعدتك اليوم؟";this._createBotMessageContainer(t)}),300)}_render(){const t=document.createElement("style");t.textContent='\n :host {\n   --primary-color: #007BFF;\n   --primary-hover: #0069d9;\n   --bg-color: #fff;\n   --header-bg: #E6F0FA;\n   --text-color: #333;\n   --text-secondary: #666;\n   --message-bg-user: var(--primary-color);\n   --message-color-user: #fff;\n   --message-bg-bot: #F8F9FA;\n   --message-color-bot: #666;\n   --border-color: #E6E6E6;\n   --footer-bg: rgba(249, 250, 251, 0.8);\n   --bubble-size: 56px;\n   --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n\n   font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, \'Helvetica Neue\', Arial, sans-serif;\n   position: fixed;\n   z-index: 9999;\n   box-sizing: border-box;\n }\n\n :host([theme="dark"]) {\n   --primary-color: #375FFF;\n   --primary-hover: #2D4ECC;\n   --bg-color: #1E1E1E;\n   --header-bg: #2D2D2D;\n   --text-color: #fff;\n   --text-secondary: #B0B0B0;\n   --message-bg-user: var(--primary-color);\n   --message-color-user: #fff;\n   --message-bg-bot: #2D2D2D;\n   --message-color-bot: #E0E0E0;\n   --border-color: #3D3D3D;\n   --footer-bg: rgba(30, 30, 30, 0.85);\n }\n\n :host([position="bottom-right"]) .chat-container {\n   bottom: 24px;\n   right: 24px;\n }\n\n :host([position="bottom-left"]) .chat-container {\n   bottom: 24px;\n   left: 24px;\n }\n\n :host([direction="rtl"]) {\n   direction: rtl;\n   text-align: right;\n }\n :host([direction="rtl"]) .header-info {\n    margin-left: auto; /* لنقل المعلومات إلى اليمين في وضع RTL */\n    margin-right: 12px;\n }\n :host([direction="rtl"]) .send-button svg {\n    transform: scaleX(-1); /* لعكس أيقونة الإرسال */\n }\n :host([direction="rtl"]) .footer-actions {\n    flex-direction: row-reverse; /* لعكس ترتيب الأزرار في الأسفل */\n }\n\n .chat-container {\n   z-index: 9999;\n   position: fixed;\n   display: flex;\n   flex-direction: column;\n   width: 350px;\n   height: calc(95vh - 32px);\n   max-height: 600px;\n   background-color: transparent; /* تم تغييرها لتكون شفافة */\n   border-radius: 24px; /* زيادة الانحناء */\n   overflow: hidden;\n   box-shadow: var(--shadow);\n   transition: transform 0.3s ease, opacity 0.3s ease;\n   transform: translateY(20px);\n   opacity: 0;\n   pointer-events: none;\n }\n\n .chat-container.open {\n   transform: translateY(0);\n   opacity: 1;\n   pointer-events: all;\n }\n\n .chat-header {\n   display: flex;\n   align-items: center;\n   padding: 16px;\n   background-color: var(--header-bg);\n   border-top-left-radius: 16px; /* تعديل للانحناء الجديد */\n   border-top-right-radius: 16px; /* تعديل للانحناء الجديد */\n   border-bottom: 1px solid var(--border-color);\n }\n\n .header-info {\n   margin-left: 12px; /* تعديل المسافة */\n   margin-right: 12px; /* تعديل المسافة */\n   flex-grow: 1; /* للسماح بالنمو وأخذ المساحة المتاحة */\n }\n\n .header-title {\n   font-size: 16px;\n   font-weight: 600;\n   color: var(--text-color);\n   margin: 0;\n }\n\n .header-subtitle {\n   font-size: 12px;\n   color: var(--text-secondary);\n   margin: 0;\n }\n\n .messages-container {\n   flex: 1;\n   padding: 16px;\n   overflow-y: auto;\n   background-color: var(--bg-color);\n   display: flex;\n   flex-direction: column;\n   gap: 16px; /* زيادة المسافة بين الرسائل */\n }\n\n /* تخصيص شريط التمرير */\n .messages-container::-webkit-scrollbar {\n   width: 6px;\n }\n .messages-container::-webkit-scrollbar-thumb {\n   background-color: rgba(0, 0, 0, 0.2);\n   border-radius: 3px;\n }\n .messages-container::-webkit-scrollbar-track {\n   background-color: transparent;\n }\n\n .chat-footer {\n   padding: 16px;\n   background-color: var(--footer-bg);\n   border-top: 1px solid var(--border-color);\n   border-bottom-left-radius: 16px; /* تعديل للانحناء الجديد */\n   border-bottom-right-radius: 16px; /* تعديل للانحناء الجديد */\n   backdrop-filter: blur(10px); /* إضافة تأثير الضبابية */\n }\n\n .input-group {\n   display: flex;\n   align-items: center;\n   gap: 8px; /* إضافة مسافة بين الحقل والزر */\n   margin-bottom: 8px; /* مسافة سفلية قبل الأزرار الإضافية */\n }\n\n .chat-input {\n   flex: 1;\n   padding: 10px 16px; /* زيادة الحشو الداخلي */\n   font-size: 14px;\n   background-color: var(--bg-color);\n   color: var(--text-color);\n   border: 1px solid var(--border-color);\n   border-radius: 9999px; /* جعله دائريًا تمامًا */\n   outline: none;\n }\n\n .chat-input::placeholder {\n   color: var(--text-secondary);\n }\n\n .send-button {\n   width: 40px; /* حجم الزر */\n   height: 40px; /* حجم الزر */\n   border-radius: 50%; /* دائري */\n   background-color: var(--primary-color);\n   color: white;\n   border: none;\n   display: flex;\n   align-items: center;\n   justify-content: center;\n   cursor: pointer;\n   transition: background-color 0.2s;\n   flex-shrink: 0; /* منع الزر من الانكماش */\n }\n\n .send-button:hover {\n   background-color: var(--primary-hover);\n }\n\n .send-button:disabled {\n   opacity: 0.5;\n   cursor: not-allowed;\n }\n\n .send-button svg {\n   width: 18px; /* حجم الأيقونة */\n   height: 18px; /* حجم الأيقونة */\n }\n\n .footer-actions {\n   display: flex;\n   justify-content: space-between;\n   align-items: center;\n   /* تم حذف margin-top */\n }\n\n .footer-button {\n   background: none;\n   border: none;\n   color: var(--text-secondary);\n   font-size: 12px;\n   cursor: pointer;\n   padding: 4px 8px;\n }\n\n .footer-button:hover {\n   color: var(--primary-color);\n }\n\n .powered-by {\n   font-size: 12px;\n   color: var(--text-secondary);\n }\n\n /* إضافة عنصر لعرض زمن الاستجابة ومعرف الجلسة (اختياري) */\n .session-info {\n   font-size: 10px;\n   color: var(--text-secondary);\n   text-align: center; /* توسيط النص */\n   margin-top: 5px;\n   display: none; /* إخفاءه مبدئياً */\n }\n :host([debug="true"]) .session-info {\n    display: block; /* إظهاره في وضع التصحيح */\n }\n';const e=document.createElement("template");e.innerHTML=`\n     <div class="chat-container">\n       <div class="chat-header">\n         <chat-avatar\n           src="${this.getAttribute("avatar")||""}"\n           fallback="${(this.getAttribute("title")||"Bot").charAt(0)}"\n           bg-color="var(--primary-color)">\n         </chat-avatar>\n         <div class="header-info">\n           <h3 class="header-title">${this.getAttribute("title")||"Chat Assistant"}</h3>\n           <p class="header-subtitle">${this.getAttribute("subtitle")||"Our virtual agent is here to help you"}</p>\n         </div>\n       </div>\n\n       <div class="messages-container" id="messages"></div>\n\n       <div class="chat-footer">\n         <div class="input-group">\n           <input type="text" class="chat-input" placeholder="اكتب رسالة..." />\n           <button class="send-button" disabled>\n             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n               <line x1="22" y1="2" x2="11" y2="13"></line>\n               <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>\n             </svg>\n           </button>\n         </div>\n         <div class="footer-actions">\n           <button class="footer-button new-chat-btn">محادثة جديدة</button>\n           <span class="powered-by">${this.getAttribute("powered-by")||"Powered by AI"}</span>\n           <button class="footer-button close-btn">إغلاق</button>\n         </div>\n          <div class="session-info">\n           <span id="session-id-display">معرف الجلسة: ${this.sessionId}</span>\n           <span id="last-response-time"></span>\n         </div>\n       </div>\n     </div>\n\n     <chat-button></chat-button>\n   `,this.shadowRoot.appendChild(t),this.shadowRoot.appendChild(e.content.cloneNode(!0)),this.chatContainer=this.shadowRoot.querySelector(".chat-container"),this.messagesContainer=this.shadowRoot.querySelector("#messages"),this.chatInput=this.shadowRoot.querySelector(".chat-input"),this.sendButton=this.shadowRoot.querySelector(".send-button"),this.chatButton=this.shadowRoot.querySelector("chat-button"),0===this.messagesContainer.children.length&&this._addInitialSuggestions()}_addInitialSuggestions(){const t=document.createElement("chat-suggestions");t.suggestions=["ما هي خدماتكم؟","كيف يمكنني التواصل معكم؟","هل لديكم خدمة توصيل؟"],this.messagesContainer.appendChild(t),this._scrollToBottom()}_setupEventListeners(){this.chatButton.addEventListener("click",(()=>this.toggleChat())),this.sendButton.addEventListener("click",(()=>this._sendMessage())),this.chatInput.addEventListener("keypress",(t=>{"Enter"!==t.key||this.sendButton.disabled||this._sendMessage()})),this.chatInput.addEventListener("input",(()=>{this.sendButton.disabled=!this.chatInput.value.trim()})),this.shadowRoot.querySelector(".new-chat-btn").addEventListener("click",(()=>this._clearChat())),this.shadowRoot.querySelector(".close-btn").addEventListener("click",(()=>this.toggleChat())),this.shadowRoot.addEventListener("suggestion-clicked",(t=>{const{suggestion:e}=t.detail;this.chatInput.value=e,this.sendButton.disabled=!1,this._sendMessage()}))}_addUserMessage(t){const e=document.createElement("chat-message");e.setAttribute("sender","user"),e.setAttribute("message-id",`user-${Date.now()}`),e.textContent=t;const n=document.createElement("span");n.className="timestamp",n.textContent=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),e.shadowRoot.querySelector(".message-content").appendChild(n),this.messagesContainer.appendChild(e),this._scrollToBottom();const s=this.shadowRoot.querySelector("chat-suggestions");s&&(s.style.display="none")}_createBotMessageContainer(t="..."){const e=document.createElement("chat-message");return e.setAttribute("sender","bot"),e.setAttribute("message-id",`bot-${Date.now()}`),e.setAttribute("avatar",this.getAttribute("avatar")||""),e.textContent=t,this.messagesContainer.appendChild(e),this._scrollToBottom(),e}_sendMessage(){const t=this.chatInput.value.trim();t&&(this._addUserMessage(t),this.chatInput.value="",this.sendButton.disabled=!0,this.chatInput.disabled=!0,this.currentBotMessageContainer=this._createBotMessageContainer(),this.responseStartTime=performance.now(),this._streamChatResponse(t,this.sessionId).catch((t=>{console.error("Streaming Error:",t),this._handleStreamError(t.message||"فشل الاتصال بالخادم.")})))}async _streamChatResponse(t,e){const n=this.getAttribute("api-url");if(!n)throw new Error("Chat API URL is not set.");const s=this.getAttribute("project-id"),o={message:t,session_id:e,debug:this.hasAttribute("debug")};s&&(o.project_id=s);const a=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream"},body:JSON.stringify(o)});if(!a.ok){let t=`HTTP error ${a.status}`;try{const e=await a.json();t=e.detail||e.message||JSON.stringify(e)}catch(e){t=await a.text()}throw new Error(t)}if(!a.body)throw new Error("No response body received from server.");const i=a.body.getReader(),r=new TextDecoder("utf-8");let c="";for(;;){const{done:t,value:e}=await i.read();if(t){console.log("Stream finished."),this.currentBotMessageContainer.classList.contains("finished")||(console.warn("Stream ended without an 'end' event. Finalizing message."),this._finishBotMessage(this.sessionId));break}c+=r.decode(e,{stream:!0});const n=c.split("\n\n");c=n.pop()||"";for(const t of n)this._processSseEvent(t)}}_processSseEvent(t){console.log("Raw SSE Event:",t);const e=t.split("\n");let n,s="message",o="";for(const t of e)t.startsWith("event:")?s=t.slice(6).trim():t.startsWith("data:")&&(o+=t.slice(5).trim());if(o){try{n=JSON.parse(o),console.log(`Parsed SSE Event (${s}):`,n)}catch(t){return console.error("JSON parse error in SSE data:",t,o),void this._handleStreamError(`خطأ في تنسيق بيانات الخادم: ${o}`)}switch(s){case"chunk":void 0!==n.content&&null!==n.content&&this._appendToBotMessage(n.content);break;case"end":this._finishBotMessage(n.session_id);break;case"error":this._handleStreamError(n.error||n.message||"حدث خطأ غير معروف من الخادم.");break;case"debug":console.log("Debug Info:",n);break;default:console.warn(`Unhandled SSE event type: ${s}`),"message"===s&&n.content&&this._appendToBotMessage(n.content)}}}_appendToBotMessage(t){this.currentBotMessageContainer||(console.error("Attempted to append text but no currentBotMessageContainer exists."),this.currentBotMessageContainer=this._createBotMessageContainer(""));const e=this.currentBotMessageContainer.shadowRoot.querySelector(".message-content");e?("..."===e.textContent&&(e.textContent=""),e.textContent+=t,this._scrollToBottom()):console.error("Could not find .message-content in currentBotMessageContainer.")}_finishBotMessage(t){if(!this.currentBotMessageContainer)return console.warn("finishBotMessage called but no currentBotMessageContainer"),this.chatInput.disabled=!1,void(this.sendButton.disabled=!this.chatInput.value.trim());this.currentBotMessageContainer.classList.add("finished");const e=performance.now(),n=((e-(this.responseStartTime||e))/1e3).toFixed(2),s=this.currentBotMessageContainer.shadowRoot.querySelector(".message-content");if(s){const t=document.createElement("span");t.className="timestamp",t.textContent=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),s.appendChild(t)}const o=this.shadowRoot.querySelector("#last-response-time");if(o&&(o.textContent=` | آخر زمن استجابة: ${n} ث`),t&&t!==this.sessionId){console.log(`Session ID changed from ${this.sessionId} to ${t}`),this.sessionId=t,localStorage.setItem("chatWidgetSessionId",t);const e=this.shadowRoot.querySelector("#session-id-display");e&&(e.textContent=`معرف الجلسة: ${t}`)}this.chatInput.disabled=!1,this.sendButton.disabled=!this.chatInput.value.trim(),this.currentBotMessageContainer=null,this.responseStartTime=null,this._scrollToBottom()}_handleStreamError(t){console.error("Stream Error Handler:",t);const e=`خطأ: ${t}`;if(this.currentBotMessageContainer&&!this.currentBotMessageContainer.classList.contains("finished")){const t=this.currentBotMessageContainer.shadowRoot.querySelector(".message-content");if(t){t.innerHTML=`<div class="error-message" style="color: red;">${e}</div>`;const n=document.createElement("span");n.className="timestamp",n.textContent=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),t.appendChild(n)}this.currentBotMessageContainer.classList.add("finished","error")}else{const t=this._createBotMessageContainer(""),n=t.shadowRoot.querySelector(".message-content");n.innerHTML=`<div class="error-message" style="color: red;">${e}</div>`;const s=document.createElement("span");s.className="timestamp",s.textContent=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),n.appendChild(s),t.classList.add("finished","error")}this.chatInput.disabled=!1,this.sendButton.disabled=!this.chatInput.value.trim(),this.currentBotMessageContainer=null,this.responseStartTime=null,this._scrollToBottom()}_showTypingIndicator(){if(this.shadowRoot.querySelector("#typing-indicator"))return;this.isTyping=!0;const t=document.createElement("typing-indicator");t.setAttribute("avatar",this.getAttribute("avatar")||""),t.id="typing-indicator",this.messagesContainer.appendChild(t),this._scrollToBottom()}_hideTypingIndicator(){this.isTyping=!1;const t=this.shadowRoot.querySelector("#typing-indicator");t&&t.remove()}_clearChat(){for(this.messages=[];this.messagesContainer.firstChild;)this.messagesContainer.removeChild(this.messagesContainer.firstChild);this.sessionId=this._generateSessionId(),localStorage.setItem("chatWidgetSessionId",this.sessionId);const t=this.shadowRoot.querySelector("#session-id-display");t&&(t.textContent=`معرف الجلسة: ${this.sessionId}`);const e=this.shadowRoot.querySelector("#last-response-time");e&&(e.textContent=""),setTimeout((()=>{const t=this.getAttribute("welcome-message")||"مرحبًا بك مجددًا! كيف يمكنني المساعدة؟";this._createBotMessageContainer(t),this._addInitialSuggestions()}),100),this.chatInput.disabled=!1,this.sendButton.disabled=!0}toggleChat(){console.log("🔘 toggleChat fired! isOpen=",this.isOpen),this.isOpen=!this.isOpen,this.isOpen?(this.chatContainer.classList.add("open"),localStorage.setItem("chatWidgetOpen","true"),setTimeout((()=>this.chatInput.focus()),300)):(this.chatContainer.classList.remove("open"),localStorage.setItem("chatWidgetOpen","false"))}_scrollToBottom(){requestAnimationFrame((()=>{setTimeout((()=>{this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}),50)}))}_loadSessionId(){let t=localStorage.getItem("chatWidgetSessionId");return t||(t=this._generateSessionId(),localStorage.setItem("chatWidgetSessionId",t)),console.log("Loaded Session ID:",t),t}_generateSessionId(){const t="session_"+Math.random().toString(36).substring(2,15)+Date.now().toString(36);return console.log("Generated New Session ID:",t),t}connectedCallback(){"true"===localStorage.getItem("chatWidgetOpen")&&setTimeout((()=>this.toggleChat()),100),this._applyDirectionAttribute(),this._applyDebugAttribute()}attributeChangedCallback(t,e,n){if(e!==n)switch(t){case"direction":this._applyDirectionAttribute();break;case"theme":break;case"title":const t=this.shadowRoot.querySelector(".header-title");t&&(t.textContent=n||"Chat Assistant");break;case"subtitle":const e=this.shadowRoot.querySelector(".header-subtitle");e&&(e.textContent=n||"Our virtual agent is here to help you");break;case"powered-by":const s=this.shadowRoot.querySelector(".powered-by");s&&(s.textContent=n||"Powered by AI");break;case"avatar":const o=this.shadowRoot.querySelector("chat-avatar");o&&o.setAttribute("src",n||"");break;case"debug":this._applyDebugAttribute()}}_applyDirectionAttribute(){const t=this.getAttribute("direction")||"rtl",e=this.shadowRoot.querySelector(".chat-input");e&&e.setAttribute("dir",t)}_applyDebugAttribute(){const t=this.shadowRoot.querySelector(".session-info");t&&(this.hasAttribute("debug")?t.style.display="block":t.style.display="none")}}customElements.define("chat-widget",a),window.ChatWidget={init:(t={})=>{const e={projectId:"",theme:"light",position:"bottom-right",welcomeMessage:"مرحبًا بك! كيف يمكنني مساعدتك اليوم؟",apiUrl:"https://exadoo-rxr9.onrender.com/bot/chat/stream",direction:"rtl",avatar:"",title:"Exaado Assistant",subtitle:"Our virtual agent is here to help you",poweredBy:"Powered by EXAADO:exaado.com",...t},n=document.createElement("chat-widget");return Object.entries(e).forEach((([t,e])=>{if(null==e||""===e)return;const s=t.replace(/([A-Z])/g,"-$1").toLowerCase();n.setAttribute(s,e)})),document.body.appendChild(n),n}},window.ChatWidgetOptions&&window.ChatWidget.init(window.ChatWidgetOptions)}();
//# sourceMappingURL=widget.min.js.map
